# Failed to Fetch 错误排查

## ✅ 已修复的配置

### 1. COEP Header 更新
- 从 `require-corp` 改为 `credentialless`
- 允许跨域资源加载，同时保持安全性

### 2. Webpack 外部依赖
- 添加了 `pino-pretty`, `lokijs`, `encoding` 到 externals
- 避免 Node.js 特定模块在浏览器中加载失败

---

## 🔍 如何诊断问题

### 打开浏览器开发者工具
按 `F12` 打开，查看以下标签页：

#### 1. Console 标签页
查找具体的错误信息：
```
Failed to fetch
TypeError: Failed to fetch
```

记录错误发生的具体位置和堆栈信息。

#### 2. Network 标签页
- 刷新页面
- 查看所有失败的请求（红色）
- 点击失败的请求查看详情
- 检查请求 URL 和响应状态

#### 3. 常见失败请求类型

**A. RPC 请求失败**
```
Request URL: http://127.0.0.1:8545
Status: (failed)
```

**可能原因：**
- ✅ Hardhat 节点未运行 → 运行 `npx hardhat node`
- ✅ 端口被占用 → 检查 `netstat -ano | findstr :8545`
- ✅ 浏览器 CORS 策略 → 已通过 headers 配置修复

**B. Wallet Connect 请求失败**
```
Request URL: https://...walletconnect.com/...
Status: (failed)
```

**可能原因：**
- ✅ 网络连接问题 → 检查互联网连接
- ✅ COEP 策略限制 → 已改为 `credentialless`

**C. RainbowKit 资源加载失败**
```
Request URL: ...rainbowkit...
Status: CORS error
```

**可能原因：**
- ✅ COEP 策略过严 → 已修复

---

## 🔄 解决步骤

### 步骤 1: 确保所有服务运行
```bash
# 检查 Hardhat 节点
netstat -ano | findstr :8545
# 应该看到: TCP 127.0.0.1:8545 ... LISTENING

# 检查前端服务
netstat -ano | findstr :3000
# 应该看到: TCP 127.0.0.1:3000 ... LISTENING
```

### 步骤 2: 重启前端服务
由于修改了 `next.config.ts`，需要重启：

```bash
# 在前端终端按 Ctrl+C 停止
# 然后重新启动
cd E:\Spring\Zama\lucky\frontend
npm run dev
```

### 步骤 3: 清除浏览器缓存
1. 按 `Ctrl+Shift+Delete`
2. 选择 "缓存的图片和文件"
3. 清除

或者使用硬刷新：`Ctrl+F5`

### 步骤 4: 检查浏览器扩展
某些扩展可能干扰：
- 广告拦截器
- 隐私保护扩展
- 安全扩展

**临时测试方法：**
使用隐私模式/无痕模式打开 http://localhost:3000

---

## 🛠️ 特定问题修复

### 问题 1: MetaMask 无法连接到本地网络

**解决方案：**
在 MetaMask 中手动添加网络：
```
网络名称: Hardhat Local
RPC URL: http://localhost:8545  (或 http://127.0.0.1:8545)
Chain ID: 31337
货币符号: ETH
```

### 问题 2: 请求被 CORS 阻止

**已通过配置修复：**
- COOP: `same-origin-allow-popups`
- COEP: `credentialless`

### 问题 3: WebSocket 连接失败

**RPC 使用 HTTP 而非 WebSocket：**
```typescript
// lib/wagmi.ts 中使用 http() 而非 webSocket()
transports: {
  [hardhat.id]: http("http://127.0.0.1:8545"),
}
```

---

## 📝 配置验证清单

- ✅ Hardhat 节点在 8545 端口运行
- ✅ 前端在 3000 端口运行
- ✅ `next.config.ts` 使用 `credentialless` COEP
- ✅ `lib/wagmi.ts` 配置正确的 RPC URL
- ✅ 浏览器已清除缓存
- ✅ 没有干扰性浏览器扩展

---

## 🆘 仍然失败？

### 收集诊断信息

1. **浏览器控制台完整错误：**
   ```
   按 F12 → Console → 截图所有红色错误
   ```

2. **Network 标签页失败请求：**
   ```
   按 F12 → Network → 刷新页面 → 截图红色请求
   点击红色请求 → 查看 Headers 和 Response
   ```

3. **终端输出：**
   ```
   Hardhat 节点终端的输出
   前端 npm run dev 的输出
   ```

### 调试模式

在浏览器控制台输入：
```javascript
// 查看 wagmi 配置
window.localStorage.setItem('wagmi.store', '{}')
// 刷新页面重新连接
```

---

## 🎯 预期正常状态

### 浏览器控制台（Console）
```
✅ 没有红色错误
⚠️ 可能有一些黄色警告（正常）
```

### Network 标签页
```
✅ 请求到 localhost:8545 状态 200
✅ 请求到 walletconnect.com 状态 200
✅ 静态资源 (_next/*) 状态 200
```

### 页面显示
```
✅ "Connect Wallet" 按钮可见且可点击
✅ 点击后弹出钱包选择模态框
✅ 能够连接 MetaMask
```

---

**修改配置后，请重启前端服务并清除浏览器缓存！**

